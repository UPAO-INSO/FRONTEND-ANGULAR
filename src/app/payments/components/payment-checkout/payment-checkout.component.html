@if (isOpen() && !existingOrder()) {
<dialog class="modal modal-open">
  <div class="modal-box bg-side-background max-w-md">
    <h3 class="font-bold text-xl text-white mb-4">
      <span class="fa-solid fa-wallet mr-2"></span>
      Procesar Pago
    </h3>

    <!-- Selección de Cliente -->
    <div class="bg-gray-800 rounded-lg p-4 mb-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-gray-400 text-sm">Cliente:</span>
        <button
          class="btn btn-sm btn-primary"
          (click)="onOpenClientSelector()"
          [disabled]="isProcessing()"
        >
          <span class="fa-solid fa-user-plus mr-1"></span>
          {{ selectedClient() ? "Cambiar" : "Seleccionar" }}
        </button>
      </div>

      @if (selectedClient()) {
      <div class="bg-gray-900 rounded-lg p-3 mt-2">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <p class="text-white font-semibold">{{ getClientFullName() }}</p>
            <div class="flex flex-col gap-1 mt-2 text-xs">
              <div class="flex items-center gap-1 text-gray-400">
                <span class="fa-solid fa-id-card"></span>
                <span>{{ selectedClient()!.documentNumber }}</span>
              </div>
              <div class="flex items-center gap-1 text-gray-400">
                <span class="fa-solid fa-envelope"></span>
                <span>{{ selectedClient()!.email }}</span>
              </div>
              <div class="flex items-center gap-1 text-gray-400">
                <span class="fa-solid fa-phone"></span>
                <span>{{ selectedClient()!.phone }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      } @else {
      <div class="text-center py-3 text-gray-500 text-sm">
        <span class="fa-solid fa-user-slash mb-1 block text-2xl"></span>
        <p>No hay cliente seleccionado</p>
      </div>
      }
    </div>

    <!-- Detalles del pago -->
    <div class="bg-gray-800 rounded-lg p-4 mb-4">
      <div class="flex justify-between items-center mb-2 gap-1">
        <span class="text-gray-400">Descripción: </span>
        <span class="text-white font-semibold truncate">{{
          paymentRequest().description
        }}</span>
      </div>

      @if (paymentRequest().orderNumber) {
      <div class="flex justify-between items-center mb-2 truncate">
        <span class="text-gray-400">Orden:</span>
        <span class="text-white">{{ paymentRequest().orderNumber }}</span>
      </div>
      }

      <div class="border-t border-gray-700 my-3"></div>

      <div class="flex justify-between items-center">
        <span class="text-gray-400 text-lg">Total a pagar:</span>
        <span class="text-success text-2xl font-bold">
          {{ formatAmount(paymentRequest().amount * 100) }}
        </span>
      </div>
    </div>

    <!-- Selección de método de pago -->
    <div class="mb-4">
      <label class="text-sm text-gray-400 mb-2 block">
        Selecciona método de pago:
      </label>
      <div class="flex gap-2">
        <button
          class="flex-1 btn btn-sm {{
            selectedPaymentMethod() === 'mobile_wallet'
              ? 'btn-primary'
              : 'btn-outline text-gray-300'
          }}"
          (click)="onSelectPaymentMethod('mobile_wallet')"
          [disabled]="isProcessing()"
        >
          <span class="fa-solid fa-mobile-screen mr-1"></span>
          Billetera Digital
        </button>
        <button
          class="flex-1 btn btn-sm {{
            selectedPaymentMethod() === 'cash'
              ? 'btn-primary'
              : 'btn-outline text-gray-300'
          }}"
          (click)="onSelectPaymentMethod('cash')"
          [disabled]="isProcessing()"
        >
          <span class="fa-solid fa-cash-register mr-1"></span>
          Efectivo
        </button>
      </div>
    </div>

    <!-- Información del método seleccionado -->
    @if (selectedPaymentMethod() === 'mobile_wallet') {
    <div
      class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-3 mb-4"
    >
      <div class="flex items-start gap-2">
        <span class="fa-solid fa-qrcode text-purple-400 mt-1 text-xl"></span>
        <div class="text-sm text-purple-300">
          <p class="font-semibold mb-1">Pago con billetera móvil</p>
          <p class="text-xs text-purple-400">
            Se generará un código QR que podrás escanear con Yape o Plin.
          </p>
          <p class="text-xs text-purple-400 mt-1">
            Monto: Entre S/ 6.00 y S/ 500.00
          </p>
        </div>
      </div>
    </div>
    } @else {
    <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 mb-4">
      <div class="flex items-start gap-2">
        <span class="fa-solid fa-shield-halved text-blue-400 mt-1"></span>
        <div class="text-sm text-blue-300">
          <p class="font-semibold mb-1">Pago con efectivo</p>
          <p class="text-xs text-blue-400">
            Registrar pedido como pagado con efectivo.
          </p>
        </div>
      </div>
    </div>
    }

    <!-- Mensaje de error -->
    @if (errorMessage()) {
    <div class="alert alert-error mb-4">
      <span class="fa-solid fa-exclamation-triangle"></span>
      <span>{{ errorMessage() }}</span>
    </div>
    }

    <!-- Botones de acción -->
    <div class="modal-action">
      <button
        class="btn text-gray-100 bg-gray-900 hover:bg-gray-600"
        (click)="onCancel()"
        [disabled]="isProcessing()"
      >
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        (click)="onPay()"
        [disabled]="isProcessing() || !selectedClient()"
      >
        @if (isProcessing()) {
        <span class="loading loading-spinner loading-sm"></span>
        <span>Procesando...</span>
        }
        <!--  -->
        @else if (selectedPaymentMethod() === 'mobile_wallet') {
        <span class="fa-solid fa-qrcode mr-2"></span>
        <span>Generar QR</span>
        }
        <!--   -->
        @else {
        <span class="fa-solid fa-money-bill-wave mr-2"></span>
        <span>Pagar con Efectivo</span>
        }
      </button>
    </div>

    <!-- Métodos de pago aceptados -->
    <div class="mt-4 pt-4 border-t border-gray-700">
      @if (selectedPaymentMethod() === 'mobile_wallet') {
      <p class="text-xs text-gray-500 text-center mb-2">
        Billeteras móviles aceptadas:
      </p>
      <div class="flex justify-center gap-4 items-center">
        <div class="text-center">
          <img
            src="/assets/images/yape-app-logo.png"
            alt="Yape"
            class="w-10 h-10 object-contain"
          />
        </div>
        <div class="text-center">
          <img
            src="/assets/images/plin-logo.png"
            alt="Plin"
            class="w-10 h-10 object-contain"
          />
        </div>
      </div>
      } @else {
      <p class="text-xs text-gray-500 text-center mb-2">Tarjetas aceptadas:</p>
      <div class="flex justify-center gap-3 opacity-70">
        <span class="fa-brands fa-cc-visa text-2xl"></span>
        <span class="fa-brands fa-cc-mastercard text-2xl"></span>
        <span class="fa-brands fa-cc-amex text-2xl"></span>
        <span class="fa-brands fa-cc-diners-club text-2xl"></span>
      </div>
      }
    </div>
  </div>
</dialog>
}

<!--  -->
@if (showPaymentSuccessModal()) {
<dialog class="modal modal-open z-9999">
  <div class="modal-box bg-side-background max-w-md">
    <div class="text-center py-6">
      <!-- Icono de éxito -->
      <div class="mb-4">
        <div
          class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto"
        >
          <span class="fa-solid fa-check text-white text-2xl"></span>
        </div>
      </div>

      <h3 class="font-bold text-2xl text-white mb-2">¡Pago Confirmado!</h3>

      <p class="text-gray-400 mb-4">Tu pago ha sido procesado exitosamente</p>

      @if (qrResponse()) {
      <div
        class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4"
      >
        <div class="flex justify-between items-center">
          <span class="text-green-400">Monto pagado:</span>
          <span class="text-green-400 text-xl font-bold">
            S/ {{ (qrResponse()!.amount / 100).toFixed(2) }}
          </span>
        </div>
        <div class="flex justify-between items-center mt-2">
          <span class="text-green-400 text-sm">Orden:</span>
          <span class="text-green-400 text-sm">
            {{ qrResponse()!.order_number }}
          </span>
        </div>
      </div>
      }

      <div class="modal-action justify-center">
        <button
          class="btn btn-success px-8"
          (click)="closePaymentSuccessModal()"
        >
          <span class="fa-solid fa-check mr-2"></span>
          Continuar
        </button>
      </div>
    </div>
  </div>
</dialog>
}

<!--  -->
@if (showQrModal() && qrResponse()) {
<!--  -->
<dialog class="modal modal-open">
  <div class="modal-box bg-side-background max-w-lg">
    <button
      class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-700 rounded-full"
      (click)="closeQrModal()"
      aria-label="Cerrar"
    >
      <span class="fa-solid fa-xmark text-xl"></span>
    </button>

    <!--  -->
    <h3 class="font-bold text-2xl text-white mb-4 text-center">
      <span class="fa-solid fa-qrcode mr-2 text-primary"></span>
      Escanea el QR para Pagar
    </h3>

    <!-- QR Code -->
    <div class="flex justify-center mb-6">
      <div class="bg-white p-4 rounded-xl shadow-xl">
        <img
          [src]="qrResponse()!.qr"
          alt="Código QR"
          class="w-64 h-64 object-contain"
        />
      </div>
    </div>

    <!-- Información de la orden -->
    <div class="bg-gray-800 rounded-lg p-4 mb-4 space-y-3">
      <!-- Monto -->
      <div class="flex justify-between items-center">
        <span class="text-gray-400">Monto a pagar:</span>
        <span class="text-success text-xl font-bold">
          S/ {{ (qrResponse()!.amount / 100).toFixed(2) }}
        </span>
      </div>

      <!-- Código de pago -->
      <div class="flex justify-between items-center">
        <span class="text-gray-400">Código de pago:</span>
        <div class="flex items-center gap-2">
          <span class="text-white font-mono text-lg">
            {{ qrResponse()!.payment_code }}
          </span>

          <button
            class="btn btn-xs text-gray-100 bg-gray-800 hover:bg-gray-600 p-2 rounded-md relative"
            (click)="copyPaymentCode()"
            title="Copiar código"
          >
            <!--  -->
            @if (showCopyToast()) {
            <span class="badge absolute bottom-7">Copiado!</span>
            }

            <span class="fa-solid fa-copy"></span>
          </button>
        </div>
      </div>

      <!-- Estado -->
      <div class="flex justify-between items-center">
        <span class="text-gray-400">Estado:</span>
        <span class="badge badge-warning">
          {{ qrResponse()!.state }}
        </span>
      </div>

      <!-- Orden número -->
      <div class="flex justify-between items-center">
        <span class="text-gray-400">Orden:</span>
        <span class="text-white">{{ qrResponse()!.order_number }}</span>
      </div>

      <!-- Fecha de expiración -->
      <div class="flex justify-between items-center">
        <span class="text-gray-400">Expira:</span>
        <span class="text-white text-sm">
          {{ qrResponse()!.expiration_date * 1000 | date : "dd/MM/yyyy HH:mm" }}
        </span>
      </div>
    </div>

    <!-- Instrucciones -->
    <div
      class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4"
    >
      <h4 class="font-semibold text-purple-300 mb-2 flex items-center gap-2">
        <span class="fa-solid fa-info-circle"></span>
        Instrucciones:
      </h4>
      <ol class="text-sm text-purple-200 space-y-2 list-decimal list-inside">
        <li>Abre tu app de Yape o Plin</li>
        <li>Escanea el código QR</li>
        <li>
          Confirma el pago de
          <strong>S/ {{ (qrResponse()!.amount / 100).toFixed(2) }}</strong>
        </li>
        <li>Espera la confirmación del pago</li>
      </ol>
    </div>

    <!-- Enlaces alternativos -->
    <div class="flex gap-2 mb-4">
      <a
        [href]="qrResponse()!.url_pe"
        target="_blank"
        class="btn btn-sm btn-outline flex-1 text-gray-100"
      >
        <span class="fa-solid fa-external-link-alt mr-1"></span>
        Abrir en navegador
      </a>
      <a
        [href]="qrResponse()!.qr"
        download="qr-pago.png"
        class="btn btn-sm btn-outline flex-1 text-gray-100"
      >
        <span class="fa-solid fa-download mr-1"></span>
        Descargar QR
      </a>
    </div>

    <!-- Logos de billeteras -->
    <div
      class="flex justify-center gap-4 items-center py-3 border-t border-gray-700"
    >
      <div class="text-xs text-gray-500">Paga con:</div>
      <img
        src="/assets/images/yape-app-logo.png"
        alt="Yape"
        class="w-8 h-8 object-contain"
      />
      <img
        src="/assets/images/plin-logo.png"
        alt="Plin"
        class="w-8 h-8 object-contain"
      />
    </div>

    <!-- Botón de cerrar -->
    <div class="modal-action">
      <button class="btn btn-primary w-full" (click)="closeQrModal()">
        <span class="fa-solid fa-check mr-2"></span>
        Entendido
      </button>
    </div>
  </div>
</dialog>
}

<!-- Modal de selección de cliente -->
<app-client-selector
  #clientSelector
  (clientSelected)="onClientSelected($event)"
  (cancel)="onClientSelectorCancel()"
/>
